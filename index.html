<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§­</text></svg>">
    <title>æ³•åœ‹æ—…éŠè¬äº‹é€š</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2d98da; --accent: #ff4757; --bg: #f1f2f6; --card-bg: #ffffff; --text: #2f3542; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { background: var(--card-bg); width: 100%; max-width: 650px; padding: 2rem; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); position: relative; }

        /* å°è¦½åˆ— */
        .nav-header { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .nav-link { text-decoration: none; color: #0056b3; background-color: #e1f0ff; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; transition: all 0.2s; }

        h2 { text-align: center; color: #1e272e; margin-bottom: 1.5rem; font-family: 'Poppins', sans-serif; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: #57606f; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; border: 2px solid #dfe4ea; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }

        button { width: 100%; padding: 14px; background: linear-gradient(135deg, #45aaf2, #2d98da); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(45, 152, 218, 0.3); }
        button:disabled { background: #a4b0be; transform: none; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.8rem; border-bottom: 1px dashed #dfe4ea; font-size: 0.85rem; color: #747d8c; }
        .reset-link { color: var(--accent); cursor: pointer; font-weight: bold; padding: 4px 8px; border-radius: 4px; background: rgba(252, 92, 101, 0.1); }
        
        #status { text-align: center; margin-top: 15px; color: #747d8c; min-height: 20px; }
        
        /* --- å…¨æ–°å¡ç‰‡è¨­è¨ˆ (è§£æ±ºæ–‡å­—æ“æ“ å•é¡Œ) --- */
        .result-card {
            background: #ffffff;
            border: 1px solid #e1e1e1;
            border-radius: 16px;
            padding: 1.2rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 8px;
            margin-bottom: 4px;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d98da;
            margin: 0;
        }
        .card-price {
            background: #f1f2f6;
            color: #57606f;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
        }
        .card-location {
            color: #ff6b6b; /* å¼·èª¿ä½ç½®é¡è‰² */
            font-weight: bold;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .card-desc {
            color: #57606f;
            font-size: 0.95rem;
            line-height: 1.6; /* å¢åŠ è¡Œè·ï¼Œè§£æ±ºæ“æ“  */
            margin: 0;
        }
        .map-btn {
            background-color: #27ae60;
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            margin-top: 8px;
            display: block;
            transition: background 0.2s;
        }
        .map-btn:hover { background-color: #219150; }
        
        .guide-tip {
            background-color: #fff3cd;
            color: #856404;
            padding: 1rem;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 5px solid #ffeeba;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-header"><a href="restaurant.html" class="nav-link">ğŸ½ï¸ åˆ‡æ›è‡³é¤å»³è©•é‘‘ â†’</a></div>
    <h2>ğŸ‡«ğŸ‡· æ³•åœ‹æ—…éŠè¬äº‹é€š</h2>
    
    <div id="loginSection" class="section active">
        <label>è«‹è¼¸å…¥ Gemini API Key ğŸ”‘</label>
        <input type="password" id="apiKeyInput" placeholder="è²¼ä¸Š Key (æš«å­˜æ–¼æ­¤åˆ†é )">
        <button onclick="saveKey()">ç¢ºèªä¸¦é–‹å§‹ä½¿ç”¨</button>
        <div style="margin-top:10px; font-size:0.8rem; color:#aaa; text-align:center;">
            (Key åƒ…æš«å­˜æ–¼æ­¤åˆ†é ï¼Œä¸æœƒä¸Šå‚³ä¼ºæœå™¨)
        </div>
    </div>

    <div id="searchSection" class="section">
        <div class="top-bar"><span>âœ… API Key å·²å°±ç·’</span><span class="reset-link" onclick="clearKey()">ğŸ”„ é‡è¨­ Key</span></div>
        
        <label>ğŸ“ æ‚¨åœ¨å“ªè£¡ï¼Ÿ(åœ°é»/åœ°å€/åœ°æ¨™)</label>
        <input type="text" id="locationInput" placeholder="ä¾‹å¦‚ï¼šç¾…æµ®å®®ã€Nice Riquierç«è»Šç«™">

        <label>ğŸ” æƒ³æ‰¾ä»€éº¼ï¼Ÿ</label>
        <input type="text" id="queryInput" placeholder="ä¾‹å¦‚ï¼šå’–å•¡å»³ã€è—¥å±€ã€è¶…å¸‚ã€æ™¯é»">
        
        <button onclick="startAnalysis()" id="btn">ğŸš€ æœå°‹é™„è¿‘æ¨è–¦</button>

        <div id="status"></div>
        <div id="result"></div>
    </div>
</div>

<script>
    window.onload = function() { checkSession(); };
    const apiKeyInput = document.getElementById('apiKeyInput');
    const locationInput = document.getElementById('locationInput');
    const queryInput = document.getElementById('queryInput');

    function checkSession() {
        if (sessionStorage.getItem('geminiKey')) showSearchUI();
        else showLoginUI();
    }

    function saveKey() {
        const key = apiKeyInput.value.trim();
        if (!key) { alert("è«‹è¼¸å…¥ API Key"); return; }
        sessionStorage.setItem('geminiKey', key);
        showSearchUI();
    }

    function clearKey() {
        sessionStorage.removeItem('geminiKey');
        document.getElementById('result').innerHTML = '';
        apiKeyInput.value = ''; 
        showLoginUI();
    }

    function showLoginUI() {
        document.getElementById('loginSection').classList.add('active');
        document.getElementById('searchSection').classList.remove('active');
    }

    function showSearchUI() {
        document.getElementById('loginSection').classList.remove('active');
        document.getElementById('searchSection').classList.add('active');
    }

    async function startAnalysis() {
        const apiKey = sessionStorage.getItem('geminiKey');
        const location = locationInput.value;
        const query = queryInput.value;
        const resultDiv = document.getElementById('result');
        const statusDiv = document.getElementById('status');
        const btn = document.getElementById('btn');

        if (!apiKey) { clearKey(); return; }
        if (!location || !query) { alert("è«‹å¡«å¯«åœ°é»å’Œæƒ³æ‰¾ä»€éº¼"); return; }

        resultDiv.innerHTML = '';
        btn.disabled = true;
        statusDiv.innerHTML = 'ğŸ§­ æ­£åœ¨æƒæå‘¨é‚Š (åŠå¾‘ 500å…¬å°ºå…§)...';

        try {
            // æŒ‡å®šä½¿ç”¨ gemini-2.5-flash
            const modelName = 'gemini-2.5-flash';
            
            // ä½¿ç”¨ JSON Schema è®“ AI å›å‚³ä¹¾æ·¨çš„æ•¸æ“šï¼Œä¸è¦å›å‚³äº‚ä¸ƒå…«ç³Ÿçš„æ–‡å­—
            const prompt = `
                ä½ æ˜¯ä¸€ä½è¬›è©±å¯¦åœ¨çš„æ³•åœ‹åœ¨åœ°å°éŠã€‚ä½¿ç”¨è€…ä½æ–¼ã€Œ${location}ã€ï¼Œæƒ³æ‰¾é™„è¿‘çš„ã€Œ${query}ã€ã€‚

                è«‹åš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ï¼š
                1. **è·é›¢é™åˆ¶**ï¼šåªèƒ½æ¨è–¦ **çœŸæ­£ä½æ–¼é™„è¿‘ (æ­¥è¡Œè·é›¢ < 500å…¬å°º)** çš„åœ°é»ã€‚å¦‚æœè©²å€åŸŸæ²’æœ‰ç›¸é—œåœ°é»ï¼Œè«‹ç›´æ¥å›å‚³ç©ºæ¸…å–®ï¼Œä¸è¦ç¡¬æ¹Šé è™•çš„æ™¯é»ã€‚
                2. **ç¦æ­¢çæ°æ™‚é–“**ï¼šä¸è¦å¯« "èµ°è·¯ 10 åˆ†é˜"ï¼Œè«‹æ”¹ç”¨ç›¸å°ä½ç½®æè¿°ï¼Œä¾‹å¦‚ "åœ¨xxåšç‰©é¤¨å¾Œæ–¹" æˆ– "ä½æ–¼xxè·¯å£"ã€‚
                3. **JSON æ ¼å¼**ï¼šè«‹å›å‚³ä¸€å€‹ JSON é™£åˆ— (Array)ï¼Œä¸è¦åŒ…å«ä»»ä½• Markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
                
                JSON çµæ§‹ç¯„ä¾‹ï¼š
                [
                    {
                        "name": "åº—å",
                        "location_hint": "ä½æ–¼éƒµå±€æ—é‚Š (ç²¾ç°¡æè¿°)",
                        "description": "ç‰¹è‰²èªªæ˜ï¼Œå¿…é»æ¨è–¦ï¼Œç´„50å­—ä»¥å…§",
                        "price": "â‚¬â‚¬",
                        "search_query": "åº—å + åŸå¸‚"
                    }
                ]

                è«‹æä¾› 3-5 å€‹æ¨è–¦ã€‚æœ€å¾Œè«‹é™„å¸¶ä¸€å€‹ "tip" æ¬„ä½æä¾›å°éŠå»ºè­°ã€‚
                æœ€çµ‚è¼¸å‡ºæ ¼å¼æ‡‰ç‚ºï¼š { "recommendations": [...], "tip": "å°éŠå»ºè­°..." }
            `;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" } // å¼·åˆ¶ AI åå‡º JSON
                })
            });

            if (!response.ok) throw new Error("API é€£ç·šå¤±æ•—");

            const data = await response.json();
            const jsonText = data.candidates[0].content.parts[0].text;
            const parsedData = JSON.parse(jsonText); // è§£æ JSON

            // é–‹å§‹æ¸²æŸ“ HTML (ç”±ç¨‹å¼ç¢¼æ§åˆ¶æ’ç‰ˆï¼Œä¿è­‰ä¸è·‘ç‰ˆ)
            let htmlContent = '';
            
            if (parsedData.recommendations && parsedData.recommendations.length > 0) {
                parsedData.recommendations.forEach(item => {
                    // å»ºç«‹ Google Maps App é€£çµ
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.search_query)}`;
                    
                    htmlContent += `
                        <div class="result-card">
                            <div class="card-header">
                                <h3 class="card-title">${item.name}</h3>
                                <span class="card-price">${item.price || 'åƒ¹æ ¼æœªçŸ¥'}</span>
                            </div>
                            <div class="card-location">ğŸ“ ${item.location_hint}</div>
                            <p class="card-desc">${item.description}</p>
                            <a href="${mapUrl}" target="_blank" class="map-btn">ğŸ—ºï¸ é–‹å•Ÿåœ°åœ– / å°èˆª</a>
                        </div>
                    `;
                });
            } else {
                htmlContent = `<div style="text-align:center; padding:20px;">æŠ±æ­‰ï¼Œé€™é™„è¿‘ä¼¼ä¹æ²’æœ‰ç¬¦åˆæ‚¨éœ€æ±‚çš„æ¨è–¦ ğŸ˜“</div>`;
            }

            // åŠ å…¥å°éŠå»ºè­°
            if (parsedData.tip) {
                htmlContent += `<div class="guide-tip">ğŸ’¡ <strong>å°éŠå°æ’‡æ­¥ï¼š</strong>${parsedData.tip}</div>`;
            }
            
            resultDiv.innerHTML = htmlContent;
            statusDiv.innerHTML = 'âœ¨ æœå°‹å®Œæˆ';

        } catch (error) {
            console.error(error);
            resultDiv.innerHTML = `<span style="color:#fc5c65;">âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</span>`;
            statusDiv.innerHTML = '';
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
