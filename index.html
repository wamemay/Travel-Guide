<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§­</text></svg>">
    <title>æ³•åœ‹æ—…éŠè¬äº‹é€š</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2d98da; --accent: #ff4757; --bg: #f1f2f6; --card-bg: #ffffff; --text: #2f3542; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { background: var(--card-bg); width: 100%; max-width: 650px; padding: 2rem; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); position: relative; }

        .nav-header { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .nav-link { text-decoration: none; color: #0056b3; background-color: #e1f0ff; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; transition: all 0.2s; }

        h2 { text-align: center; color: #1e272e; margin-bottom: 1.5rem; font-family: 'Poppins', sans-serif; }
        
        /* --- ä¿®æ­£çš„æ ¸å¿ƒï¼šé è¨­é¡¯ç¤º Loginï¼Œç”¨ JS æ§åˆ¶éš±è— --- */
        #loginSection { display: block; } /* é è¨­é¡¯ç¤ºï¼Œé˜²æ­¢ç™½å± */
        #searchSection { display: none; } /* é è¨­éš±è— */
        
        /* ç•¶æ·»åŠ  hidden class æ™‚æ‰éš±è— */
        .hidden { display: none !important; }
        .visible { display: block !important; animation: fadeIn 0.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: #57606f; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; border: 2px solid #dfe4ea; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }

        button { width: 100%; padding: 14px; background: linear-gradient(135deg, #45aaf2, #2d98da); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(45, 152, 218, 0.3); }
        button:disabled { background: #a4b0be; transform: none; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.8rem; border-bottom: 1px dashed #dfe4ea; font-size: 0.85rem; color: #747d8c; }
        .reset-link { color: var(--accent); cursor: pointer; font-weight: bold; padding: 4px 8px; border-radius: 4px; background: rgba(252, 92, 101, 0.1); }
        
        #status { text-align: center; margin-top: 15px; color: #747d8c; min-height: 20px; }
        
        /* å¡ç‰‡è¨­è¨ˆ */
        .result-card {
            background: #ffffff;
            border: 1px solid #e1e1e1;
            border-radius: 16px;
            padding: 1.2rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; margin-bottom: 4px; }
        .card-title { font-size: 1.2rem; font-weight: bold; color: #2d98da; margin: 0; flex: 1; }
        .card-price { background: #f1f2f6; color: #57606f; padding: 4px 8px; border-radius: 8px; font-size: 0.9rem; font-weight: bold; white-space: nowrap; margin-left: 10px; }
        .card-tag { color: #4b6584; background-color: #d1d8e0; font-size: 0.85rem; font-weight: bold; padding: 4px 8px; border-radius: 6px; width: fit-content; display: inline-block; }
        .card-desc { color: #57606f; font-size: 1rem; line-height: 1.6; margin: 0; }
        .map-btn { background-color: #20bf6b; color: white; text-decoration: none; padding: 12px; border-radius: 12px; font-size: 1rem; font-weight: bold; text-align: center; margin-top: 8px; display: block; box-shadow: 0 4px 6px rgba(32, 191, 107, 0.2); transition: all 0.2s; }
        .map-btn:hover { background-color: #1eb163; transform: translateY(-2px); box-shadow: 0 6px 10px rgba(32, 191, 107, 0.3); }
        .guide-tip { background-color: #fff3cd; color: #856404; padding: 1rem; border-radius: 12px; margin-top: 20px; border-left: 5px solid #ffeeba; line-height: 1.6; }
        .error-msg { color: #fc5c65; background: #ffeaa7; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #fdcb6e; }
        
        /* è¼‰å…¥å¤±æ•—æ™‚çš„ä¿éšªé¡¯ç¤º */
        #js-error-hint { color: red; text-align: center; display: none; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-header"><a href="restaurant.html" class="nav-link">ğŸ½ï¸ åˆ‡æ›è‡³é¤å»³è©•é‘‘ â†’</a></div>
    <h2>ğŸ‡«ğŸ‡· æ³•åœ‹æ—…éŠè¬äº‹é€š</h2>
    
    <noscript><div style="color:red; text-align:center; padding:10px;">âš ï¸ è«‹é–‹å•Ÿ JavaScript ä»¥ä½¿ç”¨æ­¤ç¶²é </div></noscript>
    
    <div id="loginSection">
        <label>è«‹è¼¸å…¥ Gemini API Key ğŸ”‘</label>
        <input type="password" id="apiKeyInput" placeholder="è²¼ä¸Š Key (æš«å­˜æ–¼æ­¤åˆ†é )">
        <button onclick="saveKey()">ç¢ºèªä¸¦é–‹å§‹ä½¿ç”¨</button>
        <div style="margin-top:10px; font-size:0.8rem; color:#aaa; text-align:center;">
            (Key åƒ…æš«å­˜æ–¼æ­¤åˆ†é ï¼Œä¸æœƒä¸Šå‚³ä¼ºæœå™¨)
        </div>
    </div>

    <div id="searchSection">
        <div class="top-bar"><span>âœ… API Key å·²å°±ç·’</span><span class="reset-link" onclick="clearKey()">ğŸ”„ é‡è¨­ Key</span></div>
        
        <label>ğŸ“ æ‚¨åœ¨å“ªè£¡ï¼Ÿ(åœ°é»/åœ°å€/åœ°æ¨™)</label>
        <input type="text" id="locationInput" placeholder="ä¾‹å¦‚ï¼šç¾…æµ®å®®ã€Nice Riquierç«è»Šç«™">

        <label>ğŸ” æƒ³æ‰¾ä»€éº¼ï¼Ÿ</label>
        <input type="text" id="queryInput" placeholder="ä¾‹å¦‚ï¼šå’–å•¡å»³ã€è—¥å±€ã€è¶…å¸‚ã€æ™¯é»">
        
        <button onclick="startAnalysis()" id="btn">ğŸš€ æœå°‹é™„è¿‘æ¨è–¦</button>

        <div id="status"></div>
        <div id="result"></div>
    </div>
</div>

<script>
    // ç¢ºä¿ DOM è¼‰å…¥å¾ŒåŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        checkSession();
    });

    const apiKeyInput = document.getElementById('apiKeyInput');
    const locationInput = document.getElementById('locationInput');
    const queryInput = document.getElementById('queryInput');
    const loginSec = document.getElementById('loginSection');
    const searchSec = document.getElementById('searchSection');

    function checkSession() {
        if (sessionStorage.getItem('geminiKey')) {
            showSearchUI();
        } else {
            // é è¨­å°±æ˜¯é¡¯ç¤º Loginï¼Œæ‰€ä»¥é€™è£¡ä¸ç”¨åšä»€éº¼ï¼Œä½†ç‚ºäº†ä¿éšªèµ·è¦‹ï¼š
            showLoginUI();
        }
    }

    function saveKey() {
        const key = apiKeyInput.value.trim();
        if (!key) { alert("è«‹è¼¸å…¥ API Key"); return; }
        sessionStorage.setItem('geminiKey', key);
        showSearchUI();
    }

    function clearKey() {
        sessionStorage.removeItem('geminiKey');
        document.getElementById('result').innerHTML = '';
        apiKeyInput.value = ''; 
        showLoginUI();
    }

    function showLoginUI() {
        loginSec.classList.remove('hidden');
        loginSec.style.display = 'block'; // å¼·åˆ¶é¡¯ç¤º
        searchSec.classList.add('hidden');
        searchSec.style.display = 'none';
    }

    function showSearchUI() {
        loginSec.classList.add('hidden');
        loginSec.style.display = 'none';
        searchSec.classList.remove('hidden');
        searchSec.style.display = 'block'; // å¼·åˆ¶é¡¯ç¤º
    }

    async function startAnalysis() {
        const apiKey = sessionStorage.getItem('geminiKey');
        const location = locationInput.value;
        const query = queryInput.value;
        const resultDiv = document.getElementById('result');
        const statusDiv = document.getElementById('status');
        const btn = document.getElementById('btn');

        if (!apiKey) { clearKey(); return; }
        if (!location || !query) { alert("è«‹å¡«å¯«åœ°é»å’Œæƒ³æ‰¾ä»€éº¼"); return; }

        resultDiv.innerHTML = '';
        btn.disabled = true;
        statusDiv.innerHTML = 'ğŸ§­ æ­£åœ¨æƒæå‘¨é‚Šè³‡è¨Š...';

        try {
            const modelName = 'gemini-2.5-flash';
            
            const prompt = `
                ä½ æ˜¯ä¸€ä½è¬›è©±å¯¦åœ¨çš„æ³•åœ‹åœ¨åœ°å°éŠã€‚ä½¿ç”¨è€…ä½æ–¼ã€Œ${location}ã€ï¼Œæƒ³æ‰¾é™„è¿‘çš„ã€Œ${query}ã€ã€‚

                è«‹å›å‚³ä¸€å€‹ **ç´” JSON æ ¼å¼** çš„æ¨è–¦æ¸…å–®ã€‚

                **é‡è¦è¦å‰‡ï¼š**
                1. **ä¸è¦æä¾›è·é›¢æˆ–åœ°å€**ï¼Œè«‹æ”¹ç‚ºæä¾›ã€Œé©åˆçš„æ°›åœæˆ–ç‰¹è‰²æ¨™ç±¤ã€ (ä¾‹å¦‚ï¼šç•¶åœ°äººæ„›å»ã€é©åˆæ‹ç…§ã€å®‰éœèˆ’é©ã€éœ€æ’éšŠ)ã€‚
                2. åƒ¹æ ¼è«‹ç”¨ â‚¬ ç¬¦è™Ÿè¡¨ç¤ºã€‚
                3. å¦‚æœé™„è¿‘æ²’æœ‰ç›¸é—œåœ°é»ï¼Œè«‹å›å‚³ç©ºé™£åˆ—ã€‚
                4. **çµ•å°ä¸è¦ä½¿ç”¨ Markdown** (ä¸è¦åŠ  \`\`\`json)ï¼Œç›´æ¥å›å‚³ JSON å­—ä¸²ã€‚
                
                JSON æ ¼å¼ç¯„ä¾‹ï¼š
                {
                    "recommendations": [
                        {
                            "name": "åº—å",
                            "tag": "ç‰¹è‰²æ¨™ç±¤ (ä¾‹å¦‚ï¼šé©åˆæ­‡è…³)",
                            "description": "ç°¡çŸ­ç‰¹è‰²ä»‹ç´¹ (ç´„30-50å­—)",
                            "price": "â‚¬â‚¬",
                            "search_query": "åº—å + åŸå¸‚"
                        }
                    ],
                    "tip": "ä¸€å¥å¯¦ç”¨çš„å°éŠå»ºè­°"
                }
            `;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if (!response.ok) throw new Error("API é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key");

            const data = await response.json();
            let text = data.candidates[0].content.parts[0].text;

            // ğŸ§¹ å¼·åŠ›æ¸…æ½”ï¼šå»é™¤ Markdown ç¬¦è™Ÿ
            text = text.replace(/```json/g, '').replace(/```/g, '').trim();

            let parsedData;
            try {
                parsedData = JSON.parse(text);
            } catch (e) {
                console.error("JSON Parse Error:", text);
                throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡");
            }

            let htmlContent = '';
            
            if (parsedData.recommendations && parsedData.recommendations.length > 0) {
                parsedData.recommendations.forEach(item => {
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.search_query + ' near ' + location)}`;
                    
                    htmlContent += `
                        <div class="result-card">
                            <div class="card-header">
                                <h3 class="card-title">${item.name}</h3>
                                <span class="card-price">${item.price || 'â‚¬'}</span>
                            </div>
                            <div><span class="card-tag">ğŸ·ï¸ ${item.tag}</span></div>
                            <p class="card-desc">${item.description}</p>
                            <a href="${mapUrl}" target="_blank" class="map-btn">ğŸ—ºï¸ é»æ­¤å°èˆª (Google Maps)</a>
                        </div>
                    `;
                });
            } else {
                htmlContent = `<div style="text-align:center; padding:20px; color:#666;">
                    æŠ±æ­‰ï¼Œåœ¨ã€Œ${location}ã€é™„è¿‘ä¼¼ä¹æ‰¾ä¸åˆ°ã€Œ${query}ã€ğŸ˜“<br>
                    å»ºè­°æ‚¨å˜—è©¦æ›´æ›æœå°‹é—œéµå­—ã€‚
                </div>`;
            }

            if (parsedData.tip) {
                htmlContent += `<div class="guide-tip">ğŸ’¡ <strong>è²¼å¿ƒæé†’ï¼š</strong>${parsedData.tip}</div>`;
            }
            
            resultDiv.innerHTML = htmlContent;
            statusDiv.innerHTML = 'âœ¨ æœå°‹å®Œæˆ';

        } catch (error) {
            resultDiv.innerHTML = `<div class="error-msg">âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
            statusDiv.innerHTML = '';
        }
